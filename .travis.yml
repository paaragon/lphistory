language: node_js
os: linux
node_js:
  - "10"
jobs:
  include:
    - stage: testing
      if: branch in (master, develop)
      before_install: # before npm install
        - npm run before-install
      before_script: # before running test
        - npm run before-script
      script: # if this is not set, it will run npm run test 
        - npm install codecov -g
        - npm run test
      after_success: # after test is run
        - npm run after-success
        - mv coverage/coverage-final.json coverage/coverage.json
        - codecov
      after_script: # after everything is run
        - ts-node ./afterScript.ts
    - stage: npm release
      # only release on master branch with specific commit message (generated by npm version)
      if: branch = master AND commit_message =~ /^[0-9]*\.[0-9]*\.[0-9]*$/
      before_deploy:
      - npm run build
      deploy:
        edge: true
        provider: npm
        email: "$NPM_EMAIL"
        api_key: "$NPM_TOKEN"
        cleanup: true